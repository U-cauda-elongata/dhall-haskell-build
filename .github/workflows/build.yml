name: Build

on:
  push:
    tags:
      - '*'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - aarch64-linux-gnu
          - arm-linux-gnueabihf
          # - powerpc64le-linux-gnu
          # - s390x-linux-gnu
          # - x86-64-linux-gnu
        package:
          # Building them all at once would cause GitHub Actions runner to time out.
          - dhall
          - dhall-json
          - dhall-bash
          - dhall-lsp-server
          - dhall-nix
          - dhall-openapi
          - dhall-yaml
          - dhall-docs
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: Register binfmts
        run: docker run --privileged --rm docker/binfmt:a7996909642ee92942dcd6cff44b9b95f08dad64
      - name: Set up swapfile
        # The runner has 7 GB of RAM, which is insufficient for this job.
        # It has 14 GB of SSD so let's use 13 GB of that as a swapfile.
        # <https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources>
        run: |
          sudo fallocate --length 13G /swapfile &&
          sudo chmod 600 /swapfile &&
          sudo mkswap /swapfile &&
          sudo swapon /swapfile
      - name: Build `${{ matrix.package }}`
        run: ./build.sh ${{ matrix.target }} ${{ matrix.package }}
      - name: Upload the artifact
        uses: actions/upload-artifact@v2
        with:
          path: dist/*
  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: artifact/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
